<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>屏東太平洋百貨 - 您的南國購物天堂</title>

    <!-- 站內樣式（既有） -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/header.css" />
    <!-- 報名表專用樣式（新） -->
    <link rel="stylesheet" href="css/registration.css" />

    <!-- 圖示 & 字型（如原站使用） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet" />

</head>
<body>
    <!-- 導航欄（動態載入） -->
    <div id="header-container"></div>

    <!-- 主內容 -->
    <main>
        <div id="carousel-container"></div>
        <div id="local-container"></div>
        <div id="events-container"></div>
        <div id="products-container"></div>
        <div id="main-content-container"></div>

    </main>

    <!-- 頁尾（動態載入） -->
    <div id="footer-container"></div>


    <!-- 首頁商品詳情蓋板 -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <!-- 關閉按鈕 -->
            <span class="close-btn">&times;</span>

            <!-- 商品圖片 + 標籤 -->
            <div class="product-image">
                <img src="/images/product/言久嵢.jpg" alt="極。蛋黃酥禮盒">
                <span class="badge">新品</span>
            </div>

            <!-- 品牌 + 名稱 -->
            <div class="product-header">
                <h3 class="brand">言久嵢烘焙研究室</h3>
                <h2 class="name">極。蛋黃酥禮盒</h2>
            </div>

            <!-- 價格 -->
            <div class="price">
                <span class="original">售價：$600</span>
                <span class="sale">特價：$540</span>
            </div>

            <!-- 活動時間 -->
            <p class="time">活動時間：2025/09/01 ~ 2025/09/30</p>

            <!-- 商品資訊 -->
            <p>
                <strong>【商品內容】</strong> - 蛋黃酥 x 8顆
            </p>
            <p>
                <strong>【保存效期】</strong> - 常溫保存，10天
            </p>
            <p>
                <strong>【注意事項】</strong>
            </p>
            <ul>
                <li>蛋奶素</li>
                <li>勿放置悶熱&日曬處</li>
                <li>開封後請盡速食用</li>
                <li>本產品含奶/蛋/麩質，過敏者避免食用</li>
            </ul>
        </div>
    </div>


    <!-- 報名表單蓋板（第一頁） -->
    <div id="registration-modal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-event-title">
            <span class="close-btn" aria-label="關閉">×</span>
            <h2 id="modal-event-title">活動報名</h2>

            <form id="registration-form">
                <!-- 並排：姓名＋手機 -->
                <div class="form-row">
                    <div class="field">
                        <label for="name">姓名：</label>
                        <input type="text" id="name" name="name" autocomplete="name" required />
                    </div>

                    <div class="field">
                        <label for="phone">手機：</label>
                        <input type="tel"
                               id="phone"
                               name="phone"
                               inputmode="numeric"
                               placeholder="0912345678"
                               pattern="^09\d{8}$"
                               title="請輸入 09 開頭的 10 碼手機號碼（例如：0912345678）"
                               required />
                        <small class="hint">格式：09 開頭，共 10 碼</small>
                    </div>
                </div>

                <div class="field">
                    <label for="email">信箱：</label>
                    <input type="email" id="email" name="email" placeholder="example@mail.com" required />
                </div>

                <div class="field">
                    <label for="gender">性別：</label>
                    <select id="gender" name="gender" required>
                        <option value="">請選擇</option>
                        <option value="male">男</option>
                        <option value="female">女</option>
                    </select>
                </div>

                <div class="field">
                    <label for="birthdate">出生年月日：</label>
                    <input type="date" id="birthdate" name="birthdate" required />
                </div>

                <div class="field">
                    <label>選擇活動：</label>
                    <div id="registration-events-container">
                        <div style="text-align: center; color: #888;">載入中...</div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn submit-btn">送出</button>
                </div>
            </form>
        </div>
    </div>
    <!-- 報名表單蓋板（第二頁） -->
    <div id="confirmation-modal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmation-title">
            <span class="close-btn" aria-label="關閉">×</span>
            <h2 id="confirmation-title">確認資料</h2>

            <div class="confirmation-summary">
                <div class="data-row">
                    <span class="data-label">姓名：</span>
                    <span class="data-value" id="confirm-name"></span>
                </div>
                <div class="data-row">
                    <span class="data-label">手機：</span>
                    <span class="data-value" id="confirm-phone"></span>
                </div>
                <div class="data-row">
                    <span class="data-label">信箱：</span>
                    <span class="data-value" id="confirm-email"></span>
                </div>
                <div class="data-row">
                    <span class="data-label">性別：</span>
                    <span class="data-value" id="confirm-gender"></span>
                </div>
                <div class="data-row">
                    <span class="data-label">出生年月日：</span>
                    <span class="data-value" id="confirm-birthdate"></span>
                </div>
                <div class="data-row">
                    <span class="data-label">活動名稱：</span>
                    <span class="data-value" id="confirm-event-name"></span>
                </div>
                <div class="data-row">
                    <span class="data-label">費用：</span>
                    <span class="data-value" id="confirm-event-price"></span>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn checkout-btn" onclick="proceedToCheckout()">結帳</button>
            </div>
        </div>
    </div>

    <!-- 會員登入蓋板（原有） -->
    <div id="login-modal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="login-title">
            <span class="close-btn" aria-label="關閉">×</span>
            <h2 id="login-title">會員登入</h2>
            <form id="login-form">
                <label for="username">帳號:</label>
                <input type="text" id="username" name="username" required />

                <label for="password">密碼:</label>
                <input type="password" id="password" name="password" required />

                <div class="login-links">
                    <a href="#" class="register-link">加入會員</a>
                    <span>|</span>
                    <a href="#" class="forgot-password-link">忘記密碼</a>
                </div>

                <button type="submit" class="btn submit-btn">登入</button>
            </form>
        </div>
    </div>

    <!-- 站內腳本（既有） -->
    <script src="js/carousel.js"></script>
    <script src="js/main.js"></script>

    <!-- 開/關報名蓋板 + 手機欄位輸入限制（新） -->
    <script>
        // 全域變數
        let eventsData = null;
        let selectedEventData = null;

        (function () {
            const modal = document.getElementById('registration-modal');
            if (!modal) return;

            const content = modal.querySelector('.modal-content');
            const closeBtn = modal.querySelector('.close-btn');

            // 讓 close span 也能鍵盤操作
            if (closeBtn) { closeBtn.setAttribute('role', 'button'); closeBtn.setAttribute('tabindex', '0'); }

            let lastFocus = null;
            let scrollY = 0;

            function openModal(e) {
                if (e) e.preventDefault();
                lastFocus = document.activeElement;
                scrollY = window.scrollY || document.documentElement.scrollTop || 0;
                document.body.style.top = `-${scrollY}px`;
                document.body.classList.add('modal-open');
                modal.setAttribute('aria-hidden', 'false');

                // 聚焦第一個可聚焦元素
                setTimeout(() => {
                    const first = modal.querySelector('input, select, textarea, button, [href], [tabindex]:not([tabindex="-1"])');
                    if (first) first.focus();
                }, 0);

                pauseBackground(true);
            }

            function closeModal(e) {
                if (e) e.preventDefault();
                modal.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, scrollY);
                if (lastFocus) { try { lastFocus.focus(); } catch (_) { } }
                pauseBackground(false);
            }

            // 暫停/恢復背景影片與輪播
            function pauseBackground(on) {
                document.querySelectorAll('video').forEach(v => {
                    try {
                        if (on) { v.dataset.wasPlaying = (!v.paused).toString(); v.pause(); }
                        else if (v.dataset.wasPlaying === 'true') { v.play().catch(() => { }); }
                        v.removeAttribute('data-was-playing');
                    } catch (_) { }
                });
                if (window.carousel) {
                    if (on && typeof carousel.stopAutoPlay === 'function') carousel.stopAutoPlay();
                    if (!on && typeof carousel.startAutoPlay === 'function') carousel.startAutoPlay();
                }
            }

            // 事件：用 .register-btn 開啟（事件委派）
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.register-btn');
                if (btn) openModal(e);
            });

            // 事件：關閉（X、背景、鍵盤）
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
                closeBtn.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') closeModal(e);
                });
            }
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(e); });
            document.addEventListener('keydown', (e) => {
                const open = modal.getAttribute('aria-hidden') === 'false';
                if (!open) return;

                if (e.key === 'Escape') return closeModal(e);

                if (e.key === 'Tab') {
                    const focusables = modal.querySelectorAll('a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])');
                    const nodes = Array.from(focusables).filter(el => !el.disabled && el.offsetParent !== null);
                    if (!nodes.length) return;
                    const first = nodes[0], last = nodes[nodes.length - 1];
                    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                }
            });

            // 手機欄位：僅允許數字、最長 10 碼
            document.addEventListener('input', (e) => {
                if (e.target && e.target.id === 'phone') {
                    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
                }
            });
        })();

        // 載入並顯示活動選項
        async function loadAndShowEvents() {
            try {
                const response = await fetch('/data/events/活動.json');
                eventsData = await response.json();

                let html = '';
                eventsData.events.forEach(event => {
                    if (event.active) {
                        html += `
                                    <div>
                                        <input type="radio" name="selectedEvent" value="${event.id}" id="${event.id}"
                                               data-event='${JSON.stringify(event)}' required>
                                        <label for="${event.id}">${event.event_name} - ${event.priceText}</label>
                                    </div>
                                `;
                    }
                });

                document.getElementById('registration-events-container').innerHTML = html;

                // 監聽活動選擇變化
                document.querySelectorAll('input[name="selectedEvent"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        if (this.checked) {
                            selectedEventData = JSON.parse(this.dataset.event);
                            console.log('選擇的活動:', selectedEventData);
                        }
                    });
                });

            } catch (error) {
                console.error('載入活動失敗:', error);
                document.getElementById('registration-events-container').innerHTML = '<div style="color: red;">載入活動失敗</div>';
            }
        }

        // 開啟報名表單時載入活動
        document.addEventListener('click', (e) => {
            if (e.target.closest('.register-btn')) {
                e.preventDefault();
                document.getElementById('registration-modal').setAttribute('aria-hidden', 'false');
                loadAndShowEvents();
            }
        });

        // 表單提交處理
        document.addEventListener('DOMContentLoaded', function () {
            const regForm = document.getElementById('registration-form');
            const regModal = document.getElementById('registration-modal');
            const confirmModal = document.getElementById('confirmation-modal');

            if (!regForm || !confirmModal) return;

            // 攔截表單提交
            regForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // 確認有選擇活動
                if (!selectedEventData) {
                    alert('請選擇一個活動');
                    return;
                }

                // 取得表單資料
                const formData = new FormData(this);
                const data = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    gender: formData.get('gender'),
                    birthdate: formData.get('birthdate'),
                    eventData: selectedEventData
                };

                fillConfirmData(data);

                regModal.setAttribute('aria-hidden', 'true');
                confirmModal.setAttribute('aria-hidden', 'false');
            });

            // 填入確認資料
            function fillConfirmData(data) {
                document.getElementById('confirm-name').textContent = data.name || '';
                document.getElementById('confirm-phone').textContent = data.phone || '';
                document.getElementById('confirm-email').textContent = data.email || '';
                document.getElementById('confirm-gender').textContent = data.gender === 'male' ? '男' : data.gender === 'female' ? '女' : '';
                document.getElementById('confirm-birthdate').textContent = formatDate(data.birthdate) || '';
                document.getElementById('confirm-event-name').textContent = data.eventData.event_name || '';
                document.getElementById('confirm-event-price').textContent = data.eventData.priceText || '';
            }

            // 格式化日期
            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return `${date.getFullYear()}年${(date.getMonth() + 1).toString().padStart(2, '0')}月${date.getDate().toString().padStart(2, '0')}日`;
            }

            // 確認頁面的關閉按鈕
            const confirmCloseBtn = confirmModal.querySelector('.close-btn');
            if (confirmCloseBtn) {
                confirmCloseBtn.addEventListener('click', function () {
                    confirmModal.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('modal-open');
                    document.body.style.top = '';
                });
            }
        });

        // 結帳
        function proceedToCheckout() {
            if (!selectedEventData) {
                alert('活動資料遺失，請重新選擇');
                return;
            }

            // 收集並修正資料格式
            let gender = document.getElementById('confirm-gender').textContent;
            if (gender === '男') gender = 'male';
            if (gender === '女') gender = 'female';

            const data = {
                action: 'register',
                name: document.getElementById('confirm-name').textContent,
                phone: document.getElementById('confirm-phone').textContent,
                email: document.getElementById('confirm-email').textContent,
                gender: gender,  // 使用修正後的性別值
                birthdate: document.getElementById('confirm-birthdate').textContent,
                id: selectedEventData.id,
                event_name: selectedEventData.event_name,
                price: selectedEventData.price,
                priceText: selectedEventData.priceText
            };

            console.log('準備發送的資料:', data);
            showLoadingMessage('正在處理中請稍後...');

            // 統一發送報名資料
            fetch('https://script.google.com/macros/s/AKfycbxBgDhAy2Wx7xs8iLcxeqHtWYv29YIiyT9SG6uYNHrmQICHuGnrVMTgWgW0WqAE0e1p/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    console.log('回應結果:', result);

                    if (result.statusCode === 200 && result.body.success) {
                        if (selectedEventData.price === 0) {
                            // 免費活動：直接完成
                            hideLoadingMessage();
                            alert('免費活動報名成功！');
                            closeAllModals();
                        } else {
                            // 付費活動：進入 LINE Pay 流程
                            const orderId = result.body.data.order_id;
                            console.log('報名記錄建立成功，Order ID:', orderId);
                            initiateLinePayment(data, orderId);
                        }
                    } else {
                        hideLoadingMessage();
                        alert('報名失敗：' + (result.body?.error || '未知錯誤'));
                    }
                })
                .catch(err => {
                    console.error('發送錯誤:', err);
                    hideLoadingMessage();
                    alert('網路錯誤，請檢查連線後重試。');
                });
        }

        // 載入訊息函數（移到外面）
        function showLoadingMessage(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-overlay';
            loadingDiv.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; justify-content: center;
        align-items: center; z-index: 10000; color: white; font-size: 18px;
    `;
            loadingDiv.innerHTML = `
        <div style="text-align: center;">
            <div style="margin-bottom: 15px;">⏳</div>
            <div id="loading-text">${message}</div>
        </div>
    `;
            document.body.appendChild(loadingDiv);
        }

        function updateLoadingMessage(message) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
        }

        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('loading-overlay');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }


        // LINE Pay 付款流程
        function initiateLinePayment(eventData, orderId) {
            updateLoadingMessage('正在準備付款...');

            const linePayData = {
                action: 'linepay_request',
                order_id: orderId,
                amount: eventData.price,
                event_name: eventData.event_name
            };

            console.log('準備發送 LINE Pay 請求:', linePayData);

            fetch('https://script.google.com/macros/s/AKfycbxBgDhAy2Wx7xs8iLcxeqHtWYv29YIiyT9SG6uYNHrmQICHuGnrVMTgWgW0WqAE0e1p/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: JSON.stringify(linePayData)
            })
                .then(response => response.json())
                .then(result => {
                    console.log('LINE Pay 請求結果:', result);
                    hideLoadingMessage();

                    if (result.statusCode === 200 && result.body?.data) {
                        const paymentUrl = result.body.paymentUrl || 'https://sandbox-pay.line.me/web/v3/payments/dummy-transaction-id/checkout'; // fallback 測試
                        const transactionId = result.body.transactionId || 'dummyTxId';

                        // 儲存交易資訊
                        localStorage.setItem('linepay_transaction', JSON.stringify({
                            transactionId: transactionId,
                            orderId: orderId,
                            amount: eventData.price,
                            eventName: eventData.event_name
                        }));

                        alert('報名記錄已建立，即將導向 LINE Pay 付款頁面...');
                        closeAllModals();

                        setTimeout(() => {
                            window.location.href = paymentUrl;
                        }, 1000);

                    } else {
                        alert('LINE Pay 請求失敗：' + (result.body?.error || '未知錯誤'));
                    }
                })
                .catch(error => {
                    console.error('LINE Pay 請求錯誤:', error);
                    hideLoadingMessage();
                    alert('付款請求失敗，請檢查連線後重試。');
                });
        }
        // 關閉所有蓋板
        function closeAllModals() {
            document.getElementById('confirmation-modal').setAttribute('aria-hidden', 'true');
            document.getElementById('registration-modal').setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
        }

        // 顯示付款完成訊息
        function showPaymentCompleteMessage() {
            const completeDiv = document.createElement('div');
            completeDiv.id = 'payment-complete-overlay';
            completeDiv.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; justify-content: center;
        align-items: center; z-index: 10000; color: white; font-size: 18px;
    `;
            completeDiv.innerHTML = `
        <div style="text-align: center;">
            <div style="margin-bottom: 15px;">✅</div>
            <div>已完成付款</div>
        </div>
    `;
            document.body.appendChild(completeDiv);

            // 3秒後自動關閉
            setTimeout(() => {
                completeDiv.remove();
            }, 3000);
        }

        // 頁面載入時檢查是否從 LINE Pay 回來
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = urlParams.get('transactionId');

            if (transactionId) {
                // 顯示付款完成訊息
                showPaymentCompleteMessage();

                // 清除 URL 參數
                setTimeout(() => {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 100);
            }
        });
    </script>
</body>
</html>
